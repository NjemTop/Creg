{% extends "base.html" %}

{% load static %}

{% block title %} –õ–æ–≥–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ #{{ mailing.id }} {% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'mailings/css/mailing_detail.css' %}">
{% endblock %}

{% block content %}
<div id="mailing-container" class="container mt-4" data-mailing-id="{{ mailing.id }}">
    <h2 class="text-center">–î–µ—Ç–∞–ª–∏ —Ä–∞—Å—Å—ã–ª–∫–∏ #{{ mailing.id }}</h2>

    <div class="card p-3 mt-3">
        <h5 class="mb-3">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–æ–π</h5>
    
        <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'mailing:mailing_list' %}" class="styled-btn-sm">
                ‚Üê –ù–∞–∑–∞–¥
            </a>
    
            {% if mailing.status == "in_progress" %}
                <button id="stop-mailing-btn" class="styled-btn-sm">
                    üõë –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                </button>
            {% elif mailing.status == "completed" or mailing.status == "failed" %}
                <button id="repeat-mailing-btn" class="styled-btn-sm">
                    üîÅ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                </button>
            {% endif %}
        </div>
    </div>

    <div class="card p-3 mt-3">
        <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Å—ã–ª–∫–µ</h5>
        <p><strong>–†–µ–∂–∏–º:</strong> {{ mailing.get_mode_display }}</p>
        <p><strong>–Ø–∑—ã–∫:</strong> {{ mailing.language }}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span id="mailing-status">{{ mailing.get_status_display }}</span></p>
        <p><strong>–í–µ—Ä—Å–∏—è:</strong> {{ mailing.release_number }}</p>
        <p><strong>–ù–∞—á–∞–ª–æ:</strong> {{ mailing.started_at|default:"-" }}</p>
        <p><strong>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:</strong> {{ mailing.completed_at|default:"-" }}</p>
    </div>

    <div class="card p-3 mt-3">
        <h5>–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</h5>

        <input type="text" id="search-input" class="form-control mb-3" placeholder="üîé –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É –∏–ª–∏ email">

        <div class="table-responsive" id="recipients-container">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>–ö–ª–∏–µ–Ω—Ç</th>
                        <th>Email</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="recipients-list">
                    {% for client, contacts in grouped_recipients.items %}
                        {% for contact in contacts %}
                            <tr class="recipient-row"
                                data-client-id="{% if client == test_recipient_label %}test{% else %}{{ client.id }}{% endif %}"
                                data-client-name="{% if client == test_recipient_label %}{{ client }}{% else %}{{ client.client_name }}{% endif %}"
                                data-email="{{ contact.email }}">
                                {% if forloop.first %}
                                    <td class="client-name-cell" rowspan="{{ contacts|length }}">
                                        {% if client == test_recipient_label %}
                                            {{ client }}
                                        {% else %}
                                            {{ client.client_name|default:"‚Äî" }}
                                        {% endif %}
                                    </td>
                                {% endif %}
                                <td>{{ contact.email }}</td>
                                <td class="status-cell recipient-{{ contact.status }}">{{ contact.get_status_display }}</td>
                            </tr>
                        {% endfor %}
                    {% empty %}
                        <tr>
                            <td colspan="3" class="text-muted text-center">üì≠ –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π –Ω–µ—Ç</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="card p-3 mt-3">
        <h5 class="mb-3">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h5>
    
        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
            <div class="btn-group btn-group-sm" role="group">
                <button class="btn log-filter-btn active" data-level="">–í—Å–µ</button>
                <button class="btn log-filter-btn" data-level="info">INFO</button>
                <button class="btn log-filter-btn" data-level="warning">WARNING</button>
                <button class="btn log-filter-btn" data-level="error">ERROR</button>
                <button class="btn log-filter-btn" data-level="critical">CRITICAL</button>
            </div>
    
            <input type="text" id="log-search" class="form-control form-control-sm" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º..." style="max-width: 250px;">
        </div>
    
        <ul id="log-container" class="log-list">
            {% for log in logs %}
                <li class="log-entry log-{{ log.level }}">
                    <span class="log-time">[{{ log.timestamp|date:"d.m.Y H:i:s" }}]</span>
                    <span class="log-level">({{ log.get_level_display }})</span>
                    <span class="log-message">{{ log.message }}</span>
                </li>
            {% empty %}
                <li class="text-muted">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script src="{% static 'mailings/js/mailing_detail.js' %}"></script>

{% endblock %}
